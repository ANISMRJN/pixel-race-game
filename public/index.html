<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Pixel Track Stars</title>
    <script src="/socket.io/socket.io.js"></script>
    <style>
        body { background: #5c94fc; color: white; font-family: 'Courier New', monospace; text-align: center; margin: 0; overflow: hidden; display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100vh; touch-action: manipulation; }
        canvas { background: #4a7c44; border: 6px solid #8b4513; image-rendering: pixelated; box-shadow: 0 10px 0 #5d2e0a; max-width: 95vw; }
        #overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 100; }
        .card { background: white; padding: 30px; border-radius: 20px; color: #333; border: 6px solid #f8b800; width: 280px; }
        input { padding: 12px; font-size: 18px; border: 3px solid #5c94fc; border-radius: 8px; width: 80%; margin-bottom: 15px; outline: none; }
        button { padding: 15px 30px; font-size: 20px; background: #ff4d4d; color: white; border: none; border-radius: 10px; cursor: pointer; font-family: inherit; box-shadow: 0 5px 0 #b33636; width: 100%; }
        button:disabled { background: #ccc; box-shadow: 0 5px 0 #999; cursor: not-allowed; }
        #resetBtn { display: none; position: fixed; bottom: 30px; background: #4dff4d; box-shadow: 0 5px 0 #2d9d2d; width: 220px; z-index: 50; }
        #status { text-shadow: 2px 2px #000; margin: 10px; height: 50px; transition: all 0.2s; }
    </style>
</head>
<body>

    <div id="overlay">
        <div class="card">
            <h2 style="margin-top:0">üèÉ PIXEL RACE üèÉ</h2>
            <input type="text" id="nick" placeholder="Name..." maxlength="10">
            <br>
            <button id="startBtn">CONNECTING...</button>
        </div>
    </div>

    <h2 id="status">MASH TO RUN!</h2>
    <canvas id="gameCanvas" width="800" height="400"></canvas>
    <button id="resetBtn">PLAY AGAIN</button>

    <script>
        const socket = io();
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        const startBtn = document.getElementById('startBtn');
        const resetBtn = document.getElementById('resetBtn');
        const overlay = document.getElementById('overlay');
        const statusText = document.getElementById('status');
        
        let players = {};
        let audioCtx = null;
        let isJoined = false;

        socket.on('connect', () => { startBtn.innerText = "JOIN RACE"; startBtn.disabled = false; });

        startBtn.onclick = () => {
            const name = document.getElementById('nick').value.trim() || "Racer";
            if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            socket.emit('setNickname', name);
            overlay.style.display = 'none';
            isJoined = true;
        };

        // --- COUNTDOWN LISTENERS ---
        resetBtn.onclick = () => { socket.emit('resetGame'); };

        socket.on('countdown', (count) => {
            resetBtn.style.display = 'none';
            statusText.innerText = "NEXT RACE IN: " + count;
            statusText.style.color = "#f8b800";
            statusText.style.fontSize = "40px";
        });

        socket.on('gameReset', () => {
            statusText.innerText = "GO GO GO!!!";
            statusText.style.color = "white";
            statusText.style.fontSize = "30px";
            for (let id in players) { players[id].x = 0; players[id].targetX = 0; players[id].isWinner = false; }
            setTimeout(() => { if(statusText.innerText === "GO GO GO!!!") statusText.innerText = "MASH TO RUN!"; }, 2000);
        });

        // --- DATA & DRAWING ---
        socket.on('update', (serverPlayers) => {
            let someoneWon = false;
            for (let id in serverPlayers) {
                if (!players[id]) {
                    players[id] = { ...serverPlayers[id], x: serverPlayers[id].x };
                } else {
                    players[id].targetX = serverPlayers[id].x;
                    players[id].isWinner = serverPlayers[id].isWinner;
                    players[id].lane = serverPlayers[id].lane;
                    players[id].name = serverPlayers[id].name;
                }
                if (serverPlayers[id].isWinner) someoneWon = true;
            }
            if (someoneWon) resetBtn.style.display = 'block';
            for (let id in players) { if (!serverPlayers[id]) delete players[id]; }
        });

        function handleMove() {
            if(isJoined && resetBtn.style.display !== 'block' && !statusText.innerText.includes("IN:")) {
                socket.emit('move');
                if(audioCtx) {
                    const osc = audioCtx.createOscillator();
                    const g = audioCtx.createGain();
                    osc.frequency.setValueAtTime(300 + Math.random() * 100, audioCtx.currentTime);
                    g.gain.setValueAtTime(0.05, audioCtx.currentTime);
                    osc.connect(g); g.connect(audioCtx.destination);
                    osc.start(); osc.stop(audioCtx.currentTime + 0.1);
                }
            }
        }

        window.onkeydown = (e) => { if(e.code === 'Space') handleMove(); };
        window.onpointerdown = (e) => { if (e.target.tagName !== 'BUTTON' && e.target.tagName !== 'INPUT') handleMove(); };

        function loop() {
            ctx.fillStyle = "#5c94fc"; ctx.fillRect(0,0,800,400); // Sky
            ctx.fillStyle = "#8b4513"; ctx.fillRect(0, 50, 800, 330); // Track
            ctx.fillStyle = "rgba(255,255,255,0.3)";
            for(let i=0; i<6; i++) ctx.fillRect(0, 60 + (i * 65), 800, 4);

            for (let id in players) {
                let p = players[id];
                if (p.targetX !== undefined) p.x += (p.
