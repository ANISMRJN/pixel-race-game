<!DOCTYPE html>
<html>
<head>
    <title>Pixel Track Stars</title>
    <script src="/socket.io/socket.io.js"></script>
    <style>
        /* Responsive CSS */
        body { 
            background: #5c94fc; 
            color: white; 
            font-family: 'Courier New', monospace; 
            margin: 0; 
            display: flex; 
            flex-direction: column;
            align-items: center; 
            justify-content: center; 
            height: 100vh; 
            overflow: hidden;
            touch-action: manipulation; /* Prevents zooming when mashing */
        }
        
        canvas { 
            background: #4a7c44; 
            border: 6px solid #8b4513; 
            image-rendering: pixelated; 
            box-shadow: 0 10px 0 #5d2e0a; 
            max-width: 95vw; /* Fits phone screens */
            max-height: 70vh;
        }

        #overlay { 
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: rgba(92, 148, 252, 0.95); 
            display: flex; flex-direction: column; align-items: center; justify-content: center; 
            z-index: 100; 
        }

        .card { background: white; padding: 25px; border-radius: 20px; border: 6px solid #f8b800; color: #333; text-align: center; }
        
        button { 
            padding: 15px 30px; font-size: 20px; background: #ff4d4d; color: white; 
            border: none; border-radius: 10px; cursor: pointer; 
            box-shadow: 0 5px 0 #b33636; font-family: inherit; 
        }

        .mobile-hint {
            margin-top: 10px;
            font-size: 18px;
            color: yellow;
            text-shadow: 2px 2px #000;
        }
    </style>
</head>
<body>

    <div id="overlay">
        <div class="card">
            <h1 style="margin:0">üèÉ TRACK STARS üèÉ</h1>
            <p>Type your name to join:</p>
            <input type="text" id="nick" placeholder="Name..." maxlength="10" style="padding:10px; font-size:18px; width: 80%;">
            <br><br>
            <button id="joinBtn">ENTER STADIUM</button>
        </div>
    </div>

    <div id="ui">
        <h2 id="status" style="text-shadow: 2px 2px #000; margin-bottom: 5px;">MASH THE SCREEN TO RUN!</h2>
    </div>
    
    <canvas id="gameCanvas" width="800" height="400"></canvas>
    
    <div class="mobile-hint">Tap Screen (Mobile) or Space (PC)</div>

<script>
    const socket = io();
    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');
    let players = {};
    let fireworks = [];
    let audioCtx = null;

    // Start Game Function
    function start() {
        if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        socket.emit('setNickname', document.getElementById('nick').value || "Racer");
        document.getElementById('overlay').style.display = 'none';
    }

    document.getElementById('joinBtn').addEventListener('click', start);

    // --- SOUND ENGINE ---
    function playTapSound() {
        if (!audioCtx) return;
        const osc = audioCtx.createOscillator();
        const g = audioCtx.createGain();
        osc.type = 'sine';
        osc.frequency.setValueAtTime(250 + Math.random() * 200, audioCtx.currentTime);
        osc.frequency.exponentialRampToValueAtTime(10, audioCtx.currentTime + 0.1);
        g.gain.setValueAtTime(0.1, audioCtx.currentTime);
        osc.connect(g); g.connect(audioCtx.destination);
        osc.start(); osc.stop(audioCtx.currentTime + 0.1);
    }

    // --- MULTIPLAYER INPUT (TOUCH & KEYBOARD) ---
    function handleAction(e) {
        // Prevent default only for touch to stop scrolling/zooming while mashing
        if(e.type === 'touchstart') e.preventDefault();
        
        // If the game has started (overlay is gone), send move
        if(document.getElementById('overlay').style.display === 'none') {
            socket.emit('move');
            playTapSound();
        }
    }

    // Listen for Spacebar (PC)
    window.addEventListener('keydown', (e) => { if(e.code === 'Space') handleAction(e); });
    
    // Listen for Taps/Touches (Mobile/iPad)
    canvas.addEventListener('touchstart', handleAction, { passive: false });
    canvas.addEventListener('mousedown', handleAction); // For mouse clicks too

    // --- RENDERING LOGIC ---
    socket.on('update', (data) => { players = data; });

    function drawTrack() {
        ctx.fillStyle = "#8b4513"; ctx.fillRect(0, 50, 800, 330);
        ctx.fillStyle = "rgba(255,255,255,0.4)";
        for(let i=0; i<6; i++) ctx.fillRect(0, 60 + (i * 65), 800, 4);
        for(let i=0; i<20; i++) {
            ctx.fillStyle = (i % 2 === 0) ? "white" : "black";
            ctx.fillRect(750, 50 + (i * 16.5), 25, 16.5);
        }
    }

    function drawRacer(p) {
        const y = 85 + (p.index * 65);
        const bob = Math.abs(Math.sin(p.x * 0.15)) * 8;
        const squash = Math.sin(p.x * 0.15) * 4;
        ctx.save();
        ctx.translate(50 + p.x, y - bob);
        ctx.fillStyle = p.color;
        ctx.fillRect(-15, -15 + squash, 30, 30 - squash); 
        ctx.fillStyle = "white"; ctx.fillRect(5, -10, 6, 6); ctx.fillRect(15, -10, 6, 6);
        ctx.fillStyle = "black"; ctx.fillRect(8, -8, 3, 3); ctx.fillRect(18, -8, 3, 3);
        ctx.fillStyle = "gold"; ctx.fillRect(-5, -22, 10, 6); // Tiny Hat
        ctx.fillStyle = "white"; ctx.font = "bold 14px Arial"; ctx.textAlign = "center";
        ctx.fillText(p.name.toUpperCase(), 15, -30);
        if(p.isWinner) { ctx.font = "24px Arial"; ctx.fillText("üèÜ", 15, -50); }
        ctx.restore();
    }

    function loop() {
        ctx.fillStyle = "#5c94fc"; ctx.fillRect(0,0,800,400);
        drawTrack();
        Object.values(players).forEach(drawRacer);
        requestAnimationFrame(loop);
    }
    loop();
</script>
</body>
</html>
