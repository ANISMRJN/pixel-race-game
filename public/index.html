<!DOCTYPE html>
<html>
<head>
    <title>Pixel Track Stars</title>
    <script src="/socket.io/socket.io.js"></script>
    <style>
        body { background: #5c94fc; color: white; font-family: 'Courier New', monospace; margin: 0; display: flex; align-items: center; justify-content: center; height: 100vh; overflow: hidden; }
        canvas { background: #4a7c44; border: 8px solid #8b4513; image-rendering: pixelated; box-shadow: 0 10px 0 #5d2e0a; }
        #overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(92, 148, 252, 0.9); display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 100; }
        .card { background: white; padding: 30px; border-radius: 20px; border: 6px solid #f8b800; color: #333; text-align: center; }
        button { padding: 15px 30px; font-size: 20px; background: #ff4d4d; color: white; border: none; border-radius: 10px; cursor: pointer; box-shadow: 0 5px 0 #b33636; font-family: inherit; }
    </style>
</head>
<body>

    <div id="overlay">
        <div class="card">
            <h1>üèÉ TRACK STARS üèÉ</h1>
            <input type="text" id="nick" placeholder="Name..." maxlength="10" style="padding:10px; font-size:18px;">
            <br><br>
            <button onclick="start()">ENTER STADIUM</button>
        </div>
    </div>

    <canvas id="gameCanvas" width="800" height="400"></canvas>

<script>
    const socket = io();
    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');
    let players = {};
    let fireworks = [];
    let audioCtx = null;

    function start() {
        if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        socket.emit('setNickname', document.getElementById('nick').value || "Racer");
        document.getElementById('overlay').style.display = 'none';
    }

    // --- Cutesy SFX for Taps ---
    function playTapSound() {
        if (!audioCtx) return;
        const osc = audioCtx.createOscillator();
        const g = audioCtx.createGain();
        osc.type = 'sine';
        osc.frequency.setValueAtTime(200 + Math.random() * 300, audioCtx.currentTime);
        osc.frequency.exponentialRampToValueAtTime(10, audioCtx.currentTime + 0.1);
        g.gain.setValueAtTime(0.1, audioCtx.currentTime);
        osc.connect(g); g.connect(audioCtx.destination);
        osc.start(); osc.stop(audioCtx.currentTime + 0.1);
    }

    // --- Fireworks Logic ---
    function createFirework(x, y, color) {
        for(let i=0; i<20; i++) {
            fireworks.push({
                x: x, y: y,
                vx: (Math.random() - 0.5) * 10,
                vy: (Math.random() - 0.5) * 10,
                life: 1.0,
                color: color
            });
        }
    }

    socket.on('update', (data) => { 
        players = data; 
        Object.values(players).forEach(p => {
            if(p.isWinner) createFirework(750, 80 + (p.index * 65), p.color);
        });
    });

    function drawTrack() {
        // Brown Dirt Track
        ctx.fillStyle = "#8b4513";
        ctx.fillRect(0, 50, 800, 330);
        // White Lane Lines
        ctx.fillStyle = "rgba(255,255,255,0.5)";
        for(let i=0; i<6; i++) {
            ctx.fillRect(0, 60 + (i * 65), 800, 4);
        }
        // Finish Line
        for(let i=0; i<20; i++) {
            ctx.fillStyle = (i % 2 === 0) ? "white" : "black";
            ctx.fillRect(750, 50 + (i * 16.5), 25, 16.5);
        }
    }

    function drawAvatar(p) {
        const y = 85 + (p.index * 65);
        const bob = Math.abs(Math.sin(p.x * 0.15)) * 8;
        const squash = Math.sin(p.x * 0.15) * 4;

        ctx.save();
        ctx.translate(50 + p.x, y - bob);

        // Body
        ctx.fillStyle = p.color;
        ctx.fillRect(-15, -15 + squash, 30, 30 - squash); 
        // Eyes
        ctx.fillStyle = "white";
        ctx.fillRect(5, -10, 6, 6); ctx.fillRect(15, -10, 6, 6);
        ctx.fillStyle = "black";
        ctx.fillRect(8, -8, 3, 3); ctx.fillRect(18, -8, 3, 3);
        // Little Hat
        ctx.fillStyle = "gold";
        ctx.fillRect(-5, -20, 10, 5);

        if(p.isWinner) {
            ctx.fillStyle = "yellow";
            ctx.font = "20px Arial";
            ctx.fillText("‚≠ê", -5, -30);
        }
        ctx.restore();
    }

    function loop() {
        ctx.fillStyle = "#5c94fc"; ctx.fillRect(0,0,800,400); // Sky
        drawTrack();

        // Draw Fireworks
        fireworks.forEach((f, i) => {
            ctx.fillStyle = f.color;
            ctx.globalAlpha = f.life;
            ctx.fillRect(f.x, f.y, 4, 4);
            f.x += f.vx; f.y += f.vy; f.life -= 0.02;
            if(f.life <= 0) fireworks.splice(i, 1);
        });
        ctx.globalAlpha = 1.0;

        Object.values(players).forEach(drawAvatar);
        requestAnimationFrame(loop);
    }

    window.addEventListener('keydown', (e) => { 
        if(e.code === 'Space') { socket.emit('move'); playTapSound(); }
    });
    loop();
</script>
</body>
</html>
